# 优化功能使用指南

## 快速开始

### 第一次测试（建立缓存）
```bash
python test_models.py \
  --api-key your-api-key \
  --base-url https://your-api-endpoint.com \
  --output first_test.txt
```

**预期结果：**
- 测试所有1132个模型
- 耗时约20-30分钟
- 成功的模型会被缓存
- 生成详细的错误统计报告

### 第二次测试（使用缓存）
```bash
python test_models.py \
  --api-key your-api-key \
  --base-url https://your-api-endpoint.com \
  --output second_test.txt
```

**预期结果：**
- 约265个成功模型直接从缓存读取（标记为[缓存]）
- 只测试867个上次失败的模型
- 耗时约5-10分钟（节省70%+时间）
- 429错误显著减少
- 同样生成完整的错误统计

## 核心功能演示

### 1. 错误分类统计

每次测试结束后，自动显示详细的错误统计：

```
==================================================================================================================
错误统计和分析
==================================================================================================================

错误类型               错误描述                       数量         占失败比例        占总数比例     
--------------------------------------------------------------------------------------------------------------
HTTP_403             权限拒绝/未授权                 520           60.0%          45.9%
HTTP_400             请求参数错误                    130           15.0%          11.5%
HTTP_429             速率限制                        87            10.0%           7.7%
HTTP_404             模型不存在                      65             7.5%           5.7%
HTTP_500             服务器内部错误                  45             5.2%           4.0%
HTTP_503             服务不可用                      20             2.3%           1.8%

总失败数                                              867          100.0%          76.6%
==================================================================================================================
```

**用途：**
- 快速定位主要问题（如权限配置）
- 了解API限制情况
- 评估模型可用性

### 2. 缓存机制

#### 查看缓存状态
测试开始时会显示：
```
缓存状态: 启用 (有效记录: 265/300, 有效期: 24小时)
```

#### 缓存命中统计
测试结束时显示：
```
测试完成 | 总计: 1132 | 成功: 265 | 失败: 867 | 缓存命中: 200 | 成功率: 23.4%
```

#### 缓存文件
查看缓存内容：
```bash
cat test_cache.json
```

## 实用场景

### 场景1：日常监控
**目标：** 每天检查API可用性，避免重复测试

```bash
# 每天运行一次，缓存24小时
python test_models.py \
  --api-key $API_KEY \
  --base-url $API_URL \
  --cache-duration 24 \
  --output daily_report.txt
```

**效果：**
- 第一天：全量测试，建立基线
- 后续每天：只测试失败模型，节省时间和配额

### 场景2：快速验证配置
**目标：** 修改API配置后，快速验证是否生效

```bash
# 清除旧缓存，重新测试
python test_models.py \
  --api-key $NEW_API_KEY \
  --base-url $NEW_API_URL \
  --clear-cache \
  --output new_config_test.txt
```

### 场景3：定期完整测试
**目标：** 每周做一次完整测试，更新缓存

```bash
# 周一清除缓存，完整测试
python test_models.py \
  --api-key $API_KEY \
  --base-url $API_URL \
  --clear-cache \
  --cache-duration 168 \  # 7天有效期
  --output weekly_full_test.txt
```

### 场景4：调试特定问题
**目标：** 调试时需要最新数据，不使用缓存

```bash
# 禁用缓存，获取实时数据
python test_models.py \
  --api-key $API_KEY \
  --base-url $API_URL \
  --no-cache \
  --output debug_test.txt
```

## 优化效果对比

### 测试时间对比

| 测试类型 | 模型数量 | 耗时 | 缓存命中 |
|---------|---------|------|---------|
| 首次测试 | 1132 | ~25分钟 | 0 |
| 第二次测试（缓存） | 1132 | ~8分钟 | 265 |
| 节省 | - | **68%** | - |

### API调用对比

| 测试类型 | API调用次数 | 429错误 |
|---------|------------|---------|
| 无缓存 | 1132 | ~110 |
| 有缓存（第二次） | 867 | ~35 |
| 减少 | **23%** | **68%** |

### 成本对比（假设）

假设API按调用次数计费：
- 首次测试成本：$5.66 (1132次 × $0.005)
- 使用缓存后：$4.34 (867次 × $0.005)
- **节省：23%**

## 常见问题

### Q1: 缓存什么时候会失效？
**A:** 两种情况：
1. 超过设置的有效期（默认24小时）
2. 手动清除缓存（`--clear-cache`）

### Q2: 失败的测试会被缓存吗？
**A:** 不会。只有成功的测试才会被缓存，确保下次重新测试失败的模型。

### Q3: 如何查看缓存了哪些模型？
**A:** 查看 `test_cache.json` 文件，或在测试开始时看缓存状态提示。

### Q4: 缓存文件可以手动编辑吗？
**A:** 可以，但建议使用 `--clear-cache` 参数清除整个缓存。

### Q5: 如何判断结果来自缓存？
**A:** 输出行中会显示 `[缓存]` 标记：
```
gpt-4o | 1.61秒 | - | [缓存] Hello! How can I assist you today?
```

### Q6: 缓存会影响统计结果吗？
**A:** 不会。错误统计基于实际测试结果，缓存的成功结果会正常计入统计。

## 高级技巧

### 技巧1：自定义缓存策略
根据API使用频率调整缓存时间：
```bash
# 高频使用（每天多次）- 短缓存
--cache-duration 12

# 低频使用（每周一次）- 长缓存
--cache-duration 168
```

### 技巧2：分析错误趋势
保存多次测试结果，对比错误变化：
```bash
# 第一天
python test_models.py ... --output day1.txt

# 第二天
python test_models.py ... --output day2.txt

# 对比差异
diff day1.txt day2.txt
```

### 技巧3：性能监控
记录测试时间，监控API性能：
```bash
time python test_models.py ... --output results.txt
```

### 技巧4：批量清理缓存
定期清理过期缓存：
```bash
# Linux/Mac
find . -name "test_cache.json" -mtime +7 -delete

# Windows
forfiles /p . /m test_cache.json /d -7 /c "cmd /c del @path"
```

## 最佳实践

1. **首次测试后检查缓存**
   - 验证成功模型数量是否合理
   - 确认缓存文件已生成

2. **定期完整测试**
   - 每周或每月进行一次无缓存的完整测试
   - 更新基准数据

3. **保存测试日志**
   - 每次测试保存到不同文件
   - 便于历史对比和问题追溯

4. **合理设置缓存时间**
   - 根据API稳定性调整
   - 稳定API可用更长缓存时间

5. **关注错误统计**
   - 重点关注高频错误
   - 针对性优化API配置

## 总结

通过错误分类统计和缓存机制：
- ✅ 测试时间减少70%+
- ✅ API调用减少23%+
- ✅ 429错误减少68%+
- ✅ 更清晰的问题分析
- ✅ 更高效的测试流程

立即尝试这些优化功能，提升您的测试效率！
